# Course Database Storage Documentation

## ğŸ“ Where Courses Are Stored

Courses are stored in **MongoDB Atlas** (cloud database) using the connection string from your `.env` file.

### Database Configuration

1. **Connection String**: `MONGODB_URI` in `.env` file
   - Format: `mongodb+srv://username:password@cluster.mongodb.net/database-name?retryWrites=true&w=majority`
   - Example: `mongodb+srv://user:pass@cluster0.xxxxx.mongodb.net/creatormarketplace?retryWrites=true&w=majority`

2. **Database Name**: Extracted from the `MONGODB_URI` connection string
   - Usually the part after the last `/` and before `?`
   - Example: `creatormarketplace`

3. **Collection Name**: `courses`
   - This is automatically created by Mongoose when the first course is saved

---

## ğŸ’¾ How Courses Are Saved to Database

### Flow Diagram

```
Frontend (CourseBuilderPage)
    â†“
    POST /api/courses/draft
    â†“
Backend (courseController.saveDraft)
    â†“
    new Course(courseData)
    â†“
    course.save()
    â†“
MongoDB Atlas (Database)
    â†“
Collection: "courses"
```

### Step-by-Step Process

1. **Frontend Request**:
   ```typescript
   // frontend/src/components/learnloop/CourseBuilderPage.tsx
   const result = await courseService.saveDraft(courseId, draftData);
   ```

2. **API Call**:
   ```typescript
   // frontend/src/services/courseService.ts
   POST /api/courses/draft
   ```

3. **Backend Route**:
   ```javascript
   // backend/src/routes/courseRoutes.js
   router.post('/draft', courseController.saveDraft);
   ```

4. **Controller Processing**:
   ```javascript
   // backend/src/controllers/courseController.js
   const course = new Course(courseData);  // Create Mongoose model instance
   await course.save();                     // Save to MongoDB Atlas
   ```

5. **Database Save**:
   - Mongoose connects to MongoDB Atlas using `MONGODB_URI`
   - Creates/updates document in `courses` collection
   - Returns saved document with `_id`

---

## ğŸ” Verifying Database Records

### Method 1: Using Verification Script

Run the verification script to see all courses in the database:

```bash
node backend/scripts/verifyCourseStorage.js
```

This will show:
- Total number of courses
- Recent courses with details
- Database statistics
- All collections in the database

### Method 2: MongoDB Atlas Web Interface

1. Go to [MongoDB Atlas](https://cloud.mongodb.com)
2. Log in to your account
3. Select your cluster
4. Click **"Browse Collections"**
5. Select your database (e.g., `creatormarketplace`)
6. Select the `courses` collection
7. View all course documents

### Method 3: Check Backend Logs

When a course is saved, the backend logs:

```
ğŸ’¾ COURSE SAVED TO MONGODB ATLAS:
   ğŸ“ Database: creatormarketplace
   ğŸ“¦ Collection: courses
   ğŸ†” Course ID: 65a1b2c3d4e5f6g7h8i9j0k1
   ğŸ“ Course Name: Motion Design 101
   ğŸ‘¤ Instructor: 65a1b2c3d4e5f6g7h8i9j0k2
   ğŸ“Š Status: Draft
   â° Created At: 2025-01-20T10:30:00.000Z
```

---

## ğŸ“Š Database Schema

### Course Document Structure

```javascript
{
  _id: ObjectId("65a1b2c3d4e5f6g7h8i9j0k1"),  // Auto-generated by MongoDB
  name: "Motion Design 101",
  subtitle: "Learn the fundamentals",
  description: "A comprehensive course...",
  coverImage: "https://...",
  instructor: ObjectId("65a1b2c3d4e5f6g7h8i9j0k2"),  // Reference to User
  category: "Design",
  level: "Beginner",
  language: "English",
  tags: ["Motion Graphics", "Animation"],
  visibility: "Public",
  status: "Draft",
  modules: [...],
  duration: 480,
  listedPrice: { INR: 2000, USD: 25, EUR: 23 },
  sellingPrice: { INR: 1500, USD: 19, EUR: 17 },
  certificateEnabled: true,
  dripEnabled: false,
  createdAt: ISODate("2025-01-20T10:30:00.000Z"),
  lastUpdated: ISODate("2025-01-20T10:30:00.000Z"),
  enrollments: 0,
  completionRate: 0
}
```

---

## âœ… Every Backend Operation Creates/Updates Records

### Create Course (Draft)
- **Endpoint**: `POST /api/courses/draft`
- **Action**: Creates new document in `courses` collection
- **Database**: âœ… **SAVED**

### Update Course (Draft)
- **Endpoint**: `POST /api/courses/:id/draft`
- **Action**: Updates existing document in `courses` collection
- **Database**: âœ… **UPDATED**

### Update Course
- **Endpoint**: `PUT /api/courses/:id`
- **Action**: Updates existing document in `courses` collection
- **Database**: âœ… **UPDATED**

### Publish Course
- **Endpoint**: `POST /api/courses/:id/publish`
- **Action**: Updates `status` field in `courses` collection
- **Database**: âœ… **UPDATED**

### Delete Course
- **Endpoint**: `DELETE /api/courses/:id`
- **Action**: Removes document from `courses` collection
- **Database**: âœ… **DELETED**

---

## ğŸ”§ Troubleshooting

### Issue: Courses not appearing in database

1. **Check MongoDB Connection**:
   ```bash
   # Check if server is connected
   # Look for this in server logs:
   âœ… Connected to MongoDB
   ```

2. **Verify MONGODB_URI**:
   ```bash
   # Check .env file
   cat backend/.env | grep MONGODB_URI
   ```

3. **Check Backend Logs**:
   - Look for save confirmation logs
   - Check for any error messages

4. **Run Verification Script**:
   ```bash
   node backend/scripts/verifyCourseStorage.js
   ```

### Issue: "Course not found" error

- Course ID might be incorrect
- Course might have been deleted
- Check database directly using verification script

---

## ğŸ“ Important Notes

1. **Auto-Generated Fields**:
   - `_id`: Auto-generated by MongoDB
   - `createdAt`: Auto-set on creation
   - `lastUpdated`: Auto-updated on save

2. **References**:
   - `instructor` field stores ObjectId reference to User collection
   - Use `.populate('instructor')` to get full user details

3. **Indexes**:
   - Indexed on: `instructor`, `status`, `category`, `tags`, `createdAt`
   - Improves query performance

4. **Validation**:
   - All required fields are validated before saving
   - Invalid data will return 400 error

---

## ğŸš€ Quick Test

To verify everything is working:

1. **Create a course draft** from frontend
2. **Check backend logs** for save confirmation
3. **Run verification script**:
   ```bash
   node backend/scripts/verifyCourseStorage.js
   ```
4. **Check MongoDB Atlas** web interface

If all steps show the course, then âœ… **everything is working correctly!**

